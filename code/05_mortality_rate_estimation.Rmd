---
title: "Estimate mortality rates"
author: Casey Breen
---

## Summary 

In this notebook, I estimate crude daily death rates using two datasets: a respondent-level dataset and a death-level dataset. I will calculate the following sets of estimates: 

* CDR pooled (Nyemba and Kalemie only, excluding Nyunzu)
* CDR disaggregated by health zone (Nyemba and Kalemie only, excluding Nyunzu)
* CDR disaggregated by month
* CDR disaggregated by month and health zone (Nyemba and Kalemie only, excluding Nyunzu)

This code calculate separate estimates for kin tie, neighbor tie, and blended. It also by default calculates both weighted (post-stratification survey weights constructed using targets from worldpop) and unweighted estimates by default. 

The uncertainty intervals will come from 10,000 bootstrap resamples, where re-estimate the quantity of interest and take the 2.5 and 97.5th percentile. And to estimate uncertainty intervals for the weighted estimates, the code reconstructs survey weights for each bootstrap sample.

```{r}
## library packages 
library(tidyverse)
library(data.table)
library(gt)
library(here)
library(cowplot)
library(xtable)

## read in survey df
survey_df <- read_csv(here("data", "clean_data", "survey_df_cleaned_weighted_feb18_2023.csv")) %>% 
  filter(zone_de_sante_name != "Nyunzu")

## read in death df 
death_df <- read_csv(here("data", "clean_data", "death_df_cleaned_weighted_feb18_2023.csv")) %>% 
  filter(zone_de_sante_name != "Nyunzu")

## read in weighting targets 
weighting_targets <- read_csv(here("data", "weighting", "weighting_targets.csv"))

## set seed
set.seed(1)
```


## CDR pooled (Nyemba and Kalemie only, excluding Nyunzu)

The code below produces estimates of the pooled cdr with corresponding 95% uncertainty intervals 

```{r}
## calculate cdr 
cdr_pooled_point <- networksurvival::compute_cdr_comprehensive(death_df = death_df,
                                                                  survey_df = survey_df,
                                                                  weight_col = "weight_hh_sample")

## run 10,000 bootstrap samples
cdr_pooled_bootstrap <- networksurvival::compute_cdr_comprehensive(death_df = death_df,
                                                                        survey_df = survey_df,
                                                                        weight_col = "weight_hh_sample", bootstrap = 100) 

## uncertainty estimates 
cdr_pooled_uncertainty <- cdr_pooled_bootstrap %>% 
  group_by(type, weights) %>% 
  summarize(death_rate_lower = quantile(death_rate, 0.025),
            death_rate_upper = quantile(death_rate, 0.975))

## combine point estimates and 
cdr_pooled_point_uncertainty <- inner_join(cdr_pooled_point, cdr_pooled_uncertainty, by = c("weights", "type"))

# Create visualizations 
cdr_pooled_plot_new <- cdr_pooled_point_uncertainty %>% 
  filter(type != "household") %>% 
  mutate(weights = case_when(
    weights == "poststrat" ~ "Poststratification",
    weights == "unweighted" ~ "Unweighted"
  )) %>% 
  ggplot(aes(x = type, color = weights, y = death_rate, shape = weights, ymin = death_rate_lower, ymax = death_rate_upper)) + 
  geom_pointrange(position = position_dodge(.2), size = .75, fill = "white") +
  scale_shape_manual(values = c(21, 22, 23)) +
  ggsci::scale_color_lancet() + 
  ylim(0, 1) + 
  theme_half_open(12) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  labs(x = "Network Tie", y = "Estimated Average Daily Crude Death Rate")

## save main estimate plot 
ggsave(plot = cdr_pooled_plot, filename = here("figures", "cdr_pooled_plot.png"), width = 6, height = 4)
```

## CDR disaggregated by health zone (Nyemba and Kalemie only, excluding Nyunzu)

```{r}
## estimate point estimates 
cdr_pooled_hz_point <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", subpopulation = "zone_de_sante_name", bootstrap = NA)

cdr_pooled_hz_boostrap <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", subpopulation = "zone_de_sante_name", bootstrap = 10000)

## zone de sante - Uncertainty Intervals
cdr_pooled_hz_uncertainty <- cdr_pooled_hz_boostrap %>% 
  group_by(zone_de_sante_name, type, weights) %>% 
  summarize(death_rate_lower = quantile(death_rate, 0.025),
            death_rate_upper = quantile(death_rate, 0.975)) 

## perform join 
cdr_pooled_hz_point_uncertainty <- inner_join(cdr_pooled_hz_point, cdr_pooled_hz_uncertainty, by = c("type", "zone_de_sante_name", "weights"))

## visualize results 
cdr_pooled_heath_zones_plot <- cdr_pooled_hz_point_uncertainty %>% 
  filter(weights == "poststrat") %>% 
  filter(type != "household") %>% 
  ggplot(aes(x = zone_de_sante_name, color = type, shape = type, y = death_rate, ymin = death_rate_lower, ymax = death_rate_upper)) + 
  geom_pointrange( position = position_dodge(.25), size = 1, fill = "white") +
  scale_shape_manual(values = c(21, 22, 23)) +
  scale_color_viridis_d() +  
  ylim(0, 1) + 
  theme_cowplot() + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  labs(x = "Zone de Sante", y = "Estimated Average Daily Crude Death Rate")

ggsave(plot = cdr_pooled_heath_zones_plot, filename = here("figures", "cdr_pooled_heath_zones_plot.png"), width = 7, height = 5)
```


## CDR disaggregated by month

```{r}
## estimate point estimates 
cdr_monthly_point <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", bootstrap = NA, monthly = T)

## cdr monthly boostrap estimates 
cdr_monthly_bootstrap <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", bootstrap = 10000, monthly = T)

## zone de sante 
cdr_monthly_uncertainty <- cdr_monthly_bootstrap %>% 
  filter(type != "household") %>% 
  group_by(month, type) %>% 
  summarize(death_rate_lower = quantile(death_rate, 0.025),
            death_rate_upper = quantile(death_rate, 0.975))

## join together point and uncertainty estimate 
cdr_monthly_point_uncertainty <- inner_join(cdr_monthly_uncertainty, cdr_monthly_point, by = c("type", "month"))

## visualize cdr point esitmates 
cdr_monthly_plot <- cdr_monthly_point_uncertainty %>% 
  filter(type == "blended" & weights == "poststrat") %>% 
  ggplot(aes(x = month, y = death_rate)) + 
  geom_ribbon(aes(ymin = death_rate_lower, ymax = death_rate_upper), alpha = 0.1, color = "black", fill = "blue", position = position_dodge(0)) +
    geom_line(linetype = "dashed", alpha = 0.3, color = "black") +
  scale_shape_manual(values = c(21, 22, 23)) +
  ggsci::scale_color_lancet() +
  theme_cowplot() + 
  ylim(0, 1) +
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  labs(x = "Month of Death", y = "Crude Death Rate")

ggsave(plot = cdr_monthly_plot, filename = here("figures", "cdr_monthly_plot.png"), width = 6, height = 4)
```


## CDR disaggregated by month and health zone (Nyemba and Kalemie only, excluding Nyunzu)

```{r}
## estimate point estimates 
cdr_monthly_hz_point <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", subpopulation = "zone_de_sante_name", bootstrap = NA, monthly = T)

cdr_monthly_hz_bootstrap <- networksurvival::compute_cdr_comprehensive(death_df = death_df, survey_df = survey_df, weight_col = "weight_poststrat", subpopulation = "zone_de_sante_name", bootstrap = 10000, monthly = T)

## zone de sante 
cdr_monthly_hz_uncertainty <- cdr_monthly_hz_bootstrap %>% 
  group_by(month, zone_de_sante_name, type) %>% 
  summarize(death_rate_lower = quantile(death_rate, 0.025, na.rm = T),
            death_rate_upper = quantile(death_rate, 0.975, na.rm = T))

## overall estimates 
cdr_monthly_hz_point_uncertainty <- inner_join(cdr_monthly_hz_uncertainty, cdr_monthly_hz_point, by = c("type", "zone_de_sante_name", "month"))

## results monthly df 
cdr_monthly_hr_plot <- cdr_monthly_hz_point_uncertainty %>% 
 filter(month != as_date("2023-06-01")) %>% 
  filter(weights == "poststrat") %>% 
  ggplot(aes(x = month, color = type, shape = type, y = death_rate, ymin = death_rate_lower, ymax = death_rate_upper)) + 
  geom_pointrange( position = position_dodge(5), size = .75, fill = "white") +
  geom_line(linetype = "dashed", alpha = 0.3) + 
  scale_shape_manual(values = c(21, 22, 23)) +
  scale_color_viridis_d() + 
  # geom_hline(yintercept = 1, linetype = "dashed") + 
  theme_cowplot() + 
  ylim(0, 1.1) + 
  theme(legend.position = "bottom", legend.title = element_blank()) + 
  labs(x = "Month of Death", y = "Estimate Average Daily Crude Death Rate") + 
  facet_wrap(~zone_de_sante_name, ncol = 1)

ggsave(plot = cdr_monthly_hr_plot, filename = here("figures", "cdr_monthly_hz_plot.png"), width = 6, height = 8)
```

## Preregistered estimates 


```{r}
## combine cdr pooled 
cdr_estimates <- bind_rows(cdr_pooled_point_uncertainty, cdr_pooled_hz_point_uncertainty) %>% 
  mutate(zone_de_sante_name = replace_na(zone_de_sante_name, "Pooled")) %>% 
  mutate(month = "Pooled")

## combine cdr monthly 
cdr_estimates_monthly <- bind_rows(cdr_monthly_hz_point_uncertainty, cdr_monthly_point_uncertainty) %>% 
    mutate(zone_de_sante_name = replace_na(zone_de_sante_name, "Pooled")) %>% 
  mutate(month = as.character(month))

## dpylr::select columns for pre-registration 
preregistered_estimates <- cdr_estimates %>% 
  bind_rows(cdr_estimates_monthly) %>% 
  dplyr::select(type, weights, zone_de_sante_name, month, death_rate, death_rate_lower, death_rate_upper)


write_csv(preregistered_estimates, here("data", "preregistered_estimates", "preregistered_estimates.csv"))
```

